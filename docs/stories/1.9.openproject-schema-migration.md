# Story 1.9: OpenProject Schema Migration

<!-- Powered by BMADâ„¢ Core -->

## Status
Draft

## Story
**As a** system administrator,
**I want** to migrate all OpenProject tables from the `public` schema to the dedicated `openproject` schema in Supabase,
**so that** the database follows proper schema isolation, matches the container configuration, and prevents potential conflicts with other applications

## Acceptance Criteria

1. **Schema Analysis and Planning**
   - Document all OpenProject tables currently in `public` schema
   - Identify any foreign key constraints or dependencies
   - Create migration plan with rollback strategy
   - Verify no other applications are using OpenProject tables

2. **Schema Creation and Migration**
   - Create `openproject` schema in Supabase if not exists
   - Grant appropriate permissions to postgres user on `openproject` schema
   - Migrate all OpenProject tables from `public` to `openproject` schema
   - Preserve all data, indexes, constraints, and sequences
   - Update any internal references or views

3. **Configuration Updates**
   - Update docker-compose.yml to remove `public` from search path
   - Set search path to only `openproject` schema
   - Update connection configurations to ensure proper schema usage
   - Test container restart with new configuration

4. **Validation and Testing**
   - Verify all OpenProject functionality works after migration
   - Test user authentication and session management
   - Validate work packages, projects, and user data integrity
   - Confirm no application errors in container logs
   - Test file uploads and attachments if configured

## Tasks / Subtasks

- [ ] **Pre-Migration Analysis** (AC: 1)
  - [ ] SSH into production server (165.227.216.172)
  - [ ] Connect to Supabase database and list all tables in public schema
  - [ ] Identify OpenProject tables (typically prefixed with standard Rails patterns)
  - [ ] Document foreign key constraints and dependencies
  - [ ] Create database backup/snapshot in Supabase dashboard

- [ ] **Schema Setup** (AC: 2)
  - [ ] Create `openproject` schema with proper permissions
  - [ ] Test schema creation with postgres user credentials
  - [ ] Verify schema appears in search path configuration

- [ ] **Table Migration** (AC: 2)
  - [ ] Migrate tables one by one using `ALTER TABLE ... SET SCHEMA`
  - [ ] Verify data integrity after each table migration
  - [ ] Update sequences and indexes to new schema
  - [ ] Test application connectivity during migration

- [ ] **Container Configuration Update** (AC: 3)
  - [ ] Update `/root/docker-compose.yml` search path to remove `public`
  - [ ] Set `OPENPROJECT_DB__APPLICATION__MAIN__SEARCH_PATH: "openproject"`
  - [ ] Restart OpenProject containers with new configuration
  - [ ] Monitor container logs for schema-related errors

- [ ] **Production Validation** (AC: 4)
  - [ ] Test OpenProject login at https://ops.10nz.tools
  - [ ] Verify user data and work packages are accessible
  - [ ] Test creating new work packages and projects
  - [ ] Monitor application logs for 24 hours post-migration
  - [ ] Update CLAUDE.md to remove "known issue" about schema

## Dev Notes

### Current Production Context
- **Issue Identified**: OpenProject is configured to use `openproject` schema but all tables are in `public` schema
- **Production Server**: 165.227.216.172 (SSH: `ssh root@165.227.216.172`)
- **Database**: Supabase PostgreSQL (db.thnwlykidzhrsagyjncc.supabase.co)
- **Current Config**: Search path set to `"openproject,public"` as fallback
- **Risk Level**: Medium - production database changes with safety fallback

### Container Configuration Details
From `/root/docker-compose.yml` on production server:
```yaml
environment:
  DATABASE_URL: "postgresql://postgres:***@db.thnwlykidzhrsagyjncc.supabase.co:5432/postgres"
  OPENPROJECT_DB__APPLICATION__MAIN__SCHEMA: openproject
  OPENPROJECT_DB__APPLICATION__MAIN__SEARCH_PATH: "openproject,public"  # Currently using fallback
```

### Migration Strategy
1. **Low-Risk Approach**: Use PostgreSQL `ALTER TABLE ... SET SCHEMA` commands
2. **Rollback Plan**: Keep original public schema tables until validation complete
3. **Safety Net**: Current search path includes fallback to public schema during testing
4. **Validation**: Real-time testing with production OpenProject instance

### Key SQL Commands
```sql
-- Connect to Supabase
psql "postgresql://postgres:***@db.thnwlykidzhrsagyjncc.supabase.co:5432/postgres"

-- Create schema with permissions
CREATE SCHEMA IF NOT EXISTS openproject;
GRANT ALL ON SCHEMA openproject TO postgres;

-- Example table migration (repeat for each OpenProject table)
ALTER TABLE public.users SET SCHEMA openproject;
ALTER TABLE public.projects SET SCHEMA openproject;
-- ... continue for all OpenProject tables

-- Verify migration
\dt openproject.*
```

### File Locations
- **Docker Config**: `/root/docker-compose.yml` on server 165.227.216.172
- **Production Access**: https://ops.10nz.tools
- **Admin Credentials**: admin / mqsgyCQNQ2q*NCMT8QARXKJqz (from CLAUDE.md)

### Testing Standards
- **Validation Approach**: Manual testing of core OpenProject functionality
- **Test Scenarios**: Login, project creation, work package management
- **Monitoring**: Container logs and application error tracking
- **Rollback Criteria**: Any application errors or data accessibility issues

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-24 | 1.0 | Initial story creation for schema migration | Claude (System) |

## Dev Agent Record

### Agent Model Used
*To be populated by development agent*

### Debug Log References
*To be populated by development agent*

### Completion Notes List
*To be populated by development agent*

### File List
*To be populated by development agent*

## QA Results
*To be populated by QA Agent*