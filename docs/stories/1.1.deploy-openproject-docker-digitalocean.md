# Story 1.1: Deploy OpenProject via Docker Compose on Digital Ocean

## Story Overview

**Story ID**: 1.1  
**Epic**: Epic 1 - OpenProject Integration Foundation  
**Status**: Ready for Development  
**Points**: 8  
**Priority**: P0 (Foundational)  

## User Story

As a **distributed mining operations team**,  
I want **OpenProject Community Edition deployed on a reliable cloud VM with secure access**,  
So that **our team can manage work packages and projects with 99.9% uptime and sub-200ms response times**.

## Story Context

### Architecture Change Context

This story represents a complete architecture pivot from the original (impossible) Cloudflare Workers deployment to a practical VM-based Docker architecture. External consultants have confirmed that OpenProject (Ruby on Rails) cannot run on Cloudflare Workers and requires traditional VM hosting.

### System Integration

- **Deployment Platform**: Digital Ocean Droplet (s-4vcpu-8gb, NYC3 region)
- **Container Orchestration**: Docker Compose for service management
- **Database**: PostgreSQL 15 (dedicated container for OpenProject)
- **Secure Access**: Cloudflare Tunnel (zero-trust, no open ports)
- **Storage**: Cloudflare R2 for file attachments via S3-compatible API
- **Technology**: OpenProject Community Edition 14.x

## Acceptance Criteria

### Functional Requirements

1. **OpenProject Deployment**: OpenProject Community Edition 14.x successfully deployed via Docker Compose on Digital Ocean s-4vcpu-8gb droplet
2. **Database Configuration**: PostgreSQL 15 database container properly configured with persistent storage and OpenProject schema initialization
3. **Secure Access**: Cloudflare Tunnel configured for secure public access without exposing any ports directly on the VM
4. **File Storage**: Cloudflare R2 bucket integrated via S3-compatible API for OpenProject file attachments
5. **Service Orchestration**: All services (OpenProject, PostgreSQL, Cloudflare Tunnel) managed via docker-compose.yml with proper health checks
6. **SSL/TLS**: HTTPS access via Cloudflare with automatic certificate management
7. **Persistence**: Data persistence verified across container restarts and VM reboots

### Performance Requirements

8. **Response Time**: OpenProject web interface responds within 200ms for 95th percentile of requests
9. **Uptime**: Service demonstrates 99.9% availability over 24-hour test period
10. **Resource Usage**: VM resource utilization stays below 80% CPU and memory under normal load

### Security Requirements

11. **Zero-Trust Access**: No direct port exposure on Digital Ocean VM (only Cloudflare Tunnel outbound connections)
12. **Database Security**: PostgreSQL configured with secure passwords and restricted access
13. **API Security**: OpenProject API v3 endpoints accessible only through HTTPS with proper authentication

### Operational Requirements

14. **Monitoring**: Basic health checks configured for all containers with automatic restart on failure
15. **Backup Readiness**: Database configured for automated backup capability (implementation in later story)
16. **Documentation**: Complete deployment guide with all configuration files and environment variables documented

## Technical Implementation Details

### Digital Ocean VM Specification

- **Size**: s-4vcpu-8gb (4 vCPU, 8GB RAM, 160GB SSD)
- **Region**: NYC3 (optimal latency to Supabase us-east-2)
- **Cost**: $48/month (confirmed current pricing)
- **OS**: Ubuntu 22.04 LTS

### Docker Compose Architecture

```yaml
# docker-compose.yml structure (detailed configuration in implementation)
version: '3.8'
services:
  openproject:
    image: openproject/community:14
    # Resource allocation: 4GB RAM, 2 vCPU
  openproject-db:
    image: postgres:15-alpine
    # Resource allocation: 2GB RAM, 1 vCPU
  cloudflared:
    image: cloudflare/cloudflared:latest
    # Cloudflare Tunnel connector
volumes:
  openproject-data:
  openproject-db-data:
```

### Resource Allocation Strategy

| Service | Memory | CPU | Storage | Justification |
|---------|--------|-----|---------|---------------|
| OpenProject | 4GB | 2.0 | 40GB | Primary application, handles web UI and API |
| PostgreSQL | 2GB | 1.0 | 20GB | Database with moderate concurrent users |
| Cloudflare Tunnel | 256MB | 0.125 | 1GB | Lightweight tunnel connector |
| System Overhead | 1.75GB | 0.875 | 99GB | OS and Docker overhead |
| **Total** | **8GB** | **4.0** | **160GB** | Matches VM specification exactly |

### Cloudflare Tunnel Configuration

- **Tunnel Type**: Cloudflare Tunnel (not Workers)
- **Access Method**: Zero-trust via cloudflared Docker container
- **Domain**: openproject.{domain}.com (TLS managed by Cloudflare)
- **Ingress Rules**: Direct proxy to OpenProject container port 8080

### File Storage Integration

- **Provider**: Cloudflare R2 (S3-compatible)
- **Integration**: OpenProject fog gem with S3 adapter
- **Configuration**: Environment variables for R2 credentials and bucket
- **Cost**: ~$2/month for estimated file storage

## Definition of Done

- [ ] Digital Ocean VM provisioned and accessible via SSH
- [ ] Docker and Docker Compose installed on VM
- [ ] docker-compose.yml created with all required services
- [ ] Environment variables properly configured and secured
- [ ] OpenProject accessible via HTTPS through Cloudflare Tunnel
- [ ] PostgreSQL database initializes correctly with OpenProject schema
- [ ] File upload/download working via Cloudflare R2
- [ ] All containers pass health checks and restart automatically on failure
- [ ] VM resource utilization monitored and within acceptable limits
- [ ] Basic smoke tests pass (user creation, project creation, work package creation)
- [ ] Complete deployment documentation created
- [ ] QA gate assessment shows PASS status

## Risk Assessment

### Primary Risks

- **VM Resource Exhaustion**: OpenProject + PostgreSQL may exceed 8GB under load
  - **Mitigation**: Monitor resource usage, optimize PostgreSQL configuration, upgrade to s-8vcpu-16gb if needed
- **Cloudflare Tunnel Reliability**: Tunnel connection failure could make system inaccessible
  - **Mitigation**: Configure tunnel with automatic reconnection, monitor tunnel health
- **R2 Integration Complexity**: S3 compatibility may have OpenProject-specific issues
  - **Mitigation**: Test file operations thoroughly, have local volume fallback ready

### Rollback Plan

1. Destroy Digital Ocean droplet (infrastructure cost stops immediately)
2. Revert to local Docker development environment
3. Preserve database backup for quick restoration

## Dependencies

### Prerequisites

- Digital Ocean account with billing configured
- Cloudflare account with domain configured
- Cloudflare R2 bucket created with API credentials
- Docker knowledge for troubleshooting

### External Dependencies

- Digital Ocean API availability
- Cloudflare Tunnel service availability
- Docker Hub image availability (openproject/community, postgres)

## Story Validation

### Functional Validation

- OpenProject web interface loads and is fully functional
- Users can be created and assigned to projects
- Work packages can be created, updated, and deleted
- File attachments upload and download successfully
- API v3 endpoints respond correctly via HTTPS

### Performance Validation

- Load testing shows <200ms response times for standard operations
- VM resource monitoring shows sustainable resource usage
- Database queries perform adequately under normal load

### Security Validation

- Port scan confirms no exposed ports on Digital Ocean VM
- HTTPS certificate valid and auto-renewing
- Database access restricted to OpenProject container only
- API authentication working correctly

## Estimated Timeline

**Total Effort**: 6-8 hours (spread over 2-3 days for testing)

### Phase 1: Infrastructure Setup (2-3 hours)
- Provision Digital Ocean VM
- Install Docker and Docker Compose
- Configure basic security (SSH keys, firewall)

### Phase 2: OpenProject Deployment (2-3 hours)
- Create docker-compose.yml configuration
- Configure environment variables
- Deploy and test OpenProject + PostgreSQL

### Phase 3: Secure Access Setup (1-2 hours)
- Configure Cloudflare Tunnel
- Test HTTPS access and SSL certificates
- Configure domain and DNS

### Phase 4: Storage Integration (1 hour)
- Configure Cloudflare R2 integration
- Test file upload/download functionality

### Phase 5: Validation & Documentation (1-2 hours)
- Run comprehensive smoke tests
- Document configuration and deployment process
- Monitor resource usage and performance

## Success Metrics

- **Deployment Success**: OpenProject accessible via HTTPS within 4 hours of VM provisioning
- **Performance**: 95th percentile response time <200ms during 1-hour load test
- **Reliability**: Zero downtime during 24-hour monitoring period
- **Cost**: Total infrastructure cost confirmed at $48/month base + ~$2/month storage
- **Security**: Zero exposed ports confirmed via external port scan

## Notes for Implementation

### Key Configuration Files

1. **docker-compose.yml**: Complete service orchestration
2. **.env**: Environment variables (OpenProject, PostgreSQL, R2 credentials)
3. **nginx.conf**: If reverse proxy needed (may be handled by Cloudflare)
4. **tunnel.yml**: Cloudflare Tunnel ingress rules

### Critical Environment Variables

- `OPENPROJECT_SECRET_KEY_BASE`: Secure random key for OpenProject
- `POSTGRES_PASSWORD`: Secure database password
- `CLOUDFLARE_TUNNEL_TOKEN`: Tunnel authentication token
- `R2_ACCESS_KEY_ID`, `R2_SECRET_ACCESS_KEY`: File storage credentials
- `OPENPROJECT_HOST__NAME`: Domain name for OpenProject

### Performance Tuning

Based on OpenProject system requirements research:
- `OPENPROJECT_WEB_WORKERS=2` (for 4 vCPU VM)
- `OPENPROJECT_WEB_MIN_THREADS=4`
- `OPENPROJECT_WEB_MAX_THREADS=8`
- PostgreSQL shared_buffers tuned for 2GB allocation

---

**Story 1.1 Status**: Ready for development  
**Next Story**: 1.2 (Configure Supabase Webhooks) - No changes needed  
**Architecture Dependencies**: This story enables all subsequent stories in Epic 1 and Epic 2