# Story 2.1: Configure OpenProject Native Webhooks for Bidirectional Sync

**Priority:** HIGH
**Points:** 6
**Status:** Draft

## User Story
As a **project manager**, I want **OpenProject work package changes to automatically sync back to Supabase** so that **task updates made in OpenProject are reflected in the source system and available for Telegram notifications**.

## Business Value
- Enables true bidirectional sync between OpenProject and Supabase
- Maintains data consistency across all systems (Telegram, Supabase, OpenProject)
- Allows project managers to use OpenProject's advanced features while keeping Supabase as source of truth
- Provides foundation for conflict resolution and data integrity

## Acceptance Criteria

### Primary Acceptance Criteria
- [ ] OpenProject webhooks configured for work package status changes, assignments, and due date updates
- [ ] n8n-cloud workflow receives OpenProject webhook events and updates Supabase
- [ ] Conflict resolution implemented with Supabase as source of truth
- [ ] Bidirectional sync loop prevention (avoid infinite webhook cycles)
- [ ] Webhook authentication and security properly configured

### Technical Acceptance Criteria
- [ ] OpenProject webhook endpoints configured for relevant work package events
- [ ] n8n workflow processes OpenProject webhook payload format
- [ ] Supabase updates via `mcp__supabase__*` tools with proper field mapping
- [ ] Conflict detection logic implemented for concurrent updates
- [ ] Webhook delivery monitoring and error handling

### Data Integrity Acceptance Criteria
- [ ] No data loss during sync operations
- [ ] Timestamp-based conflict resolution working correctly
- [ ] Sync status tracking for debugging and monitoring
- [ ] Rollback capability for failed sync operations

## Tasks and Subtasks

### 1. OpenProject Webhook Configuration
- [ ] Access OpenProject admin settings for webhook configuration
- [ ] Create webhook endpoints for work package events:
  - Work package status changed
  - Work package assigned/reassigned  
  - Due date modified
  - Priority changed
- [ ] Configure webhook authentication using API keys or tokens
- [ ] Test webhook delivery to n8n-cloud endpoint

### 2. n8n-cloud Sync Workflow Creation  
- [ ] Use `mcp__n8n-cloud__*` tools to create OpenProject sync workflow
- [ ] Add webhook trigger node for OpenProject events
- [ ] Configure webhook authentication and payload validation
- [ ] Add data transformation nodes for field mapping

### 3. Conflict Resolution Logic
- [ ] Implement timestamp comparison logic
- [ ] Configure Supabase as authoritative source for conflicts
- [ ] Add conflict detection and resolution nodes
- [ ] Implement sync status tracking and logging

### 4. Supabase Update Integration
- [ ] Use `mcp__supabase__*` MCP tools for data updates
- [ ] Map OpenProject work package fields to Supabase tasks schema
- [ ] Add data validation and error handling
- [ ] Implement atomic update operations

### 5. Loop Prevention and Monitoring
- [ ] Add sync origin tracking to prevent webhook loops
- [ ] Implement webhook delivery monitoring
- [ ] Create error alerting and dead letter handling
- [ ] Add sync performance and health monitoring

## Dev Notes

### MCP Tools to Use
- **`mcp__n8n-cloud__*`** - For workflow creation and webhook processing
- **`mcp__supabase__*`** - For database updates and conflict resolution
- **DO NOT** create custom sync services - use n8n workflows exclusively

### OpenProject Webhook Configuration
```json
{
  "url": "https://n8n-cloud-instance.com/webhook/openproject-sync",
  "events": [
    "work_package.updated.status",
    "work_package.updated.assigned_to", 
    "work_package.updated.due_date",
    "work_package.updated.priority"
  ],
  "authentication": {
    "type": "bearer_token",
    "token": "webhook-auth-token"
  }
}
```

### n8n Workflow Structure
```
[OpenProject Webhook] 
    ↓
[Payload Validation]
    ↓
[Conflict Detection] → [Skip if Loop]
    ↓
[Data Transformation]
    ↓
[Supabase Update] → [Error Handler]
    ↓
[Sync Status Logging]
```

### Field Mapping Configuration
```javascript
const FIELD_MAPPING = {
  // OpenProject → Supabase
  "status.name": "status",
  "assigned_to.id": "assignee_id", 
  "due_date": "due_date",
  "priority.name": "priority",
  "subject": "title",
  "description": "description",
  "updated_at": "openproject_updated_at"
};
```

### Conflict Resolution Logic
```javascript
// Conflict resolution strategy
if (supabase_updated_at > openproject_updated_at) {
  // Supabase is more recent, skip OpenProject update
  return { action: "skip", reason: "supabase_newer" };
} else {
  // Apply OpenProject changes to Supabase
  return { action: "update", source: "openproject" };
}
```

### Critical Implementation Notes
- **Use OpenProject's native webhook system** - no polling or custom triggers
- **Implement proper conflict resolution** - Supabase wins on conflicts
- **Add sync origin tracking** to prevent infinite webhook loops
- **Use atomic operations** for Supabase updates to prevent partial sync states

### Dependencies  
- OpenProject instance deployed and configured (Story 1.1)
- Supabase webhook workflow operational (Story 1.2)
- n8n-cloud instance with OpenProject and Supabase integrations
- Authentication tokens for both OpenProject and Supabase

### Webhook Payload Example
```json
{
  "action": "updated",
  "work_package": {
    "id": 123,
    "subject": "Fix HVAC unit at Building A",
    "status": { "id": 2, "name": "in_progress" },
    "assigned_to": { "id": 456, "name": "Sarah Johnson" },
    "due_date": "2024-01-15T17:00:00Z",
    "updated_at": "2024-01-10T14:30:00Z"
  },
  "user": { "id": 789, "name": "Project Manager" }
}
```

## Testing Requirements

### Webhook Delivery Testing
- [ ] Test work package status change in OpenProject triggers webhook
- [ ] Test assignee change triggers webhook with correct data
- [ ] Test due date modification triggers webhook  
- [ ] Test priority changes are captured and synced
- [ ] Verify webhook authentication working correctly

### Bidirectional Sync Testing
- [ ] Create task in Telegram → verify OpenProject creation → modify in OpenProject → verify Supabase sync
- [ ] Test concurrent updates (change same task in both systems simultaneously)
- [ ] Verify conflict resolution (Supabase wins) working correctly
- [ ] Test sync loop prevention (change in Supabase shouldn't trigger loop)

### Error Handling Testing
- [ ] Test webhook delivery when n8n-cloud is down
- [ ] Test sync with invalid/corrupted webhook payloads
- [ ] Test Supabase connection failures during sync
- [ ] Verify rollback on partial sync failures

## Risks and Mitigations

### Technical Risks
- **Risk**: Webhook loops causing infinite sync cycles
  **Mitigation**: Implement sync origin tracking and loop detection

- **Risk**: Data corruption during conflict resolution
  **Mitigation**: Use atomic operations and proper transaction handling

### Business Risks
- **Risk**: Sync delays causing user confusion about task status
  **Mitigation**: Implement real-time monitoring and user feedback

## Definition of Done
- [ ] OpenProject webhooks reliably trigger on work package changes
- [ ] Bidirectional sync operational with conflict resolution
- [ ] No webhook loops or infinite sync cycles  
- [ ] Sync monitoring and error handling in place
- [ ] Data integrity maintained across all sync operations
- [ ] Ready for Story 2.2 reminder system integration

## QA Notes
- Test with realistic project manager workflows
- Verify sync works under concurrent user scenarios
- Check that sync doesn't impact OpenProject or Supabase performance
- Validate conflict resolution edge cases

### Performance Requirements
- [ ] Webhook processing < 2 seconds
- [ ] Supabase updates < 1 second
- [ ] 99.9% sync success rate
- [ ] Conflict resolution < 500ms

---

*Story follows BMAD framework v4 standards*  
*Created for Sprint 2 - Week 2 of MVP development*