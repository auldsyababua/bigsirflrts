# Story 2.3: Create Task Lists Interface via Telegram Commands

**Priority:** MEDIUM **Points:** 4 **Status:** Draft

## User Story

As a **field employee**, I want to **create filtered task views and simple
bullet lists using Telegram commands** so that **I can organize work, create
shopping lists, and manage personal reminders alongside work tasks**.

## Business Value

- Provides organized task views for better workload management
- Supports both work task filtering and personal list management
- Leverages familiar Telegram command interface
- Completes the MVP task management ecosystem

## Acceptance Criteria

### Primary Acceptance Criteria

- [ ] Telegram commands for task filtering: `/my_tasks`, `/overdue`, `/today`,
      `/this_week`
- [ ] Simple bullet list creation: `/create_list Shopping` followed by list
      items
- [ ] List management commands: `/add_to_list`, `/remove_from_list`,
      `/show_list`
- [ ] Task lists return formatted results with actionable buttons/commands
- [ ] Both filtered task queries and simple bullet lists working correctly

### Technical Acceptance Criteria

- [ ] n8n workflow handles Telegram command parsing and routing
- [ ] OpenProject/Supabase queries for filtered task views
- [ ] Simple list storage in Supabase (lists table) or workflow memory
- [ ] Telegram response formatting optimized for mobile viewing
- [ ] Command help system (`/help`) with available commands

### User Experience Acceptance Criteria

- [ ] Commands are intuitive and easy to remember
- [ ] Results displayed clearly with limited scrolling required
- [ ] List items can be checked off or marked complete
- [ ] Error messages helpful when commands fail or have invalid syntax

## Tasks and Subtasks

### 1. Telegram Command Handler Setup

- [ ] Extend existing n8n Telegram workflow to handle commands
- [ ] Add command parsing logic to route different command types
- [ ] Configure command validation and help responses
- [ ] Test basic command recognition and routing

### 2. Task Filtering Commands

- [ ] Implement `/my_tasks` - show tasks assigned to requesting user
- [ ] Implement `/overdue` - show overdue tasks for user
- [ ] Implement `/today` - show tasks due today
- [ ] Implement `/this_week` - show tasks due within 7 days
- [ ] Add pagination for large result sets

### 3. Simple List Management

- [ ] Create lists table in Supabase (or use workflow storage)
- [ ] Implement `/create_list [name]` command
- [ ] Implement `/add_to_list [list_name] [item]` command
- [ ] Implement `/show_list [list_name]` command
- [ ] Implement `/complete_item [list_name] [item]` command

### 4. Response Formatting and UX

- [ ] Design mobile-optimized message templates for task lists
- [ ] Add inline buttons for common actions (mark complete, reschedule)
- [ ] Implement pagination for long lists
- [ ] Add command shortcuts and aliases

### 5. Help System and Error Handling

- [ ] Create comprehensive `/help` command with examples
- [ ] Implement context-sensitive help for specific commands
- [ ] Add graceful error handling for invalid commands
- [ ] Test edge cases and provide clear error messages

## Dev Notes

### MCP Tools to Use

- **`mcp__n8n-cloud__*`** - For command handling workflow extension
- **`mcp__supabase__*`** - For task queries and list storage
- **Telegram Bot API** (via n8n) - For command processing and responses
- **DO NOT** create separate list management service - extend existing workflow

### Command Handler Structure

```javascript
// Command routing logic
const COMMANDS = {
  '/my_tasks': 'query_user_tasks',
  '/overdue': 'query_overdue_tasks',
  '/today': 'query_today_tasks',
  '/this_week': 'query_week_tasks',
  '/create_list': 'create_simple_list',
  '/add_to_list': 'add_list_item',
  '/show_list': 'display_list',
  '/help': 'show_help',
};
```

### n8n Workflow Extension

```
[Telegram Webhook]
    ‚Üì
[Message Type Check] ‚Üí [Regular Message Handler (existing)]
    ‚Üì (if command)
[Command Parser]
    ‚Üì
[Route to Handler] ‚Üí [Task Query] OR [List Management]
    ‚Üì
[Format Response] ‚Üí [Send Telegram Reply]
```

### Task Query Templates

```javascript
// My tasks query
const MY_TASKS_QUERY = {
  assigned_to: user_id,
  status: '!closed',
  limit: 10,
  sort: 'due_date ASC',
};

// Overdue tasks query
const OVERDUE_QUERY = {
  assigned_to: user_id,
  due_date: '<today',
  status: '!closed',
};
```

### Lists Table Schema

```sql
CREATE TABLE user_lists (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  telegram_user_id TEXT NOT NULL,
  list_name TEXT NOT NULL,
  items JSONB DEFAULT '[]',
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

### Message Formatting Templates

```javascript
// Task list response template
const TASK_LIST_TEMPLATE = `
üìã *{title}*
{task_count} tasks found

{task_items}

Use /help for more commands
`;

// Simple list response template
const SIMPLE_LIST_TEMPLATE = `
üìù *{list_name}*
{item_count} items

{list_items}

/add_to_list {list_name} [item] to add more
`;
```

### Critical Implementation Notes

- **Extend existing Telegram workflow** - don't create separate bot handlers
- **Use Supabase for persistence** of user lists and preferences
- **Implement proper user identification** via Telegram user IDs
- **Keep responses mobile-optimized** with minimal scrolling

### Telegram Command Routing Implementation (Research-Based)

```javascript
// Based on n8n community patterns for command routing
const parseCommand = (messageText) => {
  const trimmed = messageText.trim();
  if (!trimmed.startsWith('/')) return null;

  const parts = trimmed.split(' ');
  const command = parts[0].toLowerCase();
  const args = parts.slice(1);

  return { command, args, raw: trimmed };
};

// Command router configuration
const COMMAND_HANDLERS = {
  '/my_tasks': 'handleMyTasks',
  '/overdue': 'handleOverdueTasks',
  '/today': 'handleTodayTasks',
  '/this_week': 'handleWeekTasks',
  '/create_list': 'handleCreateList',
  '/add_to_list': 'handleAddToList',
  '/show_list': 'handleShowList',
  '/complete_item': 'handleCompleteItem',
  '/help': 'handleHelp',
};

// Main command processing function
const processCommand = async (update) => {
  const message = update.message;
  const chatId = message.chat.id;
  const userId = message.from.id;

  const parsed = parseCommand(message.text);
  if (!parsed) return null;

  const handler = COMMAND_HANDLERS[parsed.command];
  if (!handler) {
    return sendHelpMessage(chatId, `Unknown command: ${parsed.command}`);
  }

  return await executeHandler(handler, chatId, userId, parsed.args);
};
```

### OpenProject Task Query Implementations (Research-Based)

```javascript
// Based on OpenProject API documentation
const buildTaskQuery = (filterType, userId) => {
  const baseFilters = [
    {
      assignee: {
        operator: '=',
        values: [userId.toString()],
      },
      status: {
        operator: '!',
        values: ['12', '13'], // Exclude closed/completed
      },
    },
  ];

  switch (filterType) {
    case 'my_tasks':
      return {
        filters: JSON.stringify(baseFilters),
        sortBy: JSON.stringify([
          ['dueDate', 'asc'],
          ['priority', 'desc'],
        ]),
        pageSize: 10,
      };

    case 'overdue':
      return {
        filters: JSON.stringify([
          ...baseFilters,
          {
            dueDate: {
              operator: '<t',
              values: [],
            },
          },
        ]),
        sortBy: JSON.stringify([['dueDate', 'asc']]),
      };

    case 'today':
      return {
        filters: JSON.stringify([
          ...baseFilters,
          {
            dueDate: {
              operator: '=',
              values: ['t'],
            },
          },
        ]),
      };

    case 'this_week':
      return {
        filters: JSON.stringify([
          ...baseFilters,
          {
            dueDate: {
              operator: 'between',
              values: ['t', 't+7'],
            },
          },
        ]),
      };
  }
};

// Execute OpenProject query via n8n HTTP node
const queryOpenProject = async (queryParams) => {
  return await $http.request({
    method: 'GET',
    url: `${$env.OPENPROJECT_URL}/api/v3/work_packages`,
    qs: queryParams,
    headers: {
      Authorization: `Bearer ${$env.OPENPROJECT_API_KEY}`,
      'Content-Type': 'application/json',
    },
  });
};
```

### Dependencies

- Existing Telegram workflow operational (Story 1.3)
- Supabase tasks table accessible for queries
- User mapping between Telegram IDs and employee records
- n8n-cloud workflow with sufficient complexity handling

### Supabase List Management Implementation (Research-Based)

```javascript
// Supabase database operations for list management
const supabaseOperations = {
  // Create new list
  createList: async (telegramUserId, listName) => {
    return await $http.request({
      method: 'POST',
      url: `${$env.SUPABASE_URL}/rest/v1/user_lists`,
      headers: {
        Authorization: `Bearer ${$env.SUPABASE_ANON_KEY}`,
        apikey: $env.SUPABASE_ANON_KEY,
        'Content-Type': 'application/json',
        Prefer: 'return=representation',
      },
      body: {
        telegram_user_id: telegramUserId.toString(),
        list_name: listName,
        items: [],
      },
    });
  },

  // Add item to existing list
  addToList: async (telegramUserId, listName, item) => {
    // First get the current list
    const currentList = await $http.request({
      method: 'GET',
      url: `${$env.SUPABASE_URL}/rest/v1/user_lists`,
      headers: {
        Authorization: `Bearer ${$env.SUPABASE_ANON_KEY}`,
        apikey: $env.SUPABASE_ANON_KEY,
      },
      qs: {
        telegram_user_id: `eq.${telegramUserId}`,
        list_name: `eq.${listName}`,
        select: 'id,items',
      },
    });

    if (!currentList.data || currentList.data.length === 0) {
      throw new Error(`List "${listName}" not found`);
    }

    const list = currentList.data[0];
    const updatedItems = [
      ...(list.items || []),
      {
        text: item,
        completed: false,
        created_at: new Date().toISOString(),
      },
    ];

    // Update the list
    return await $http.request({
      method: 'PATCH',
      url: `${$env.SUPABASE_URL}/rest/v1/user_lists?id=eq.${list.id}`,
      headers: {
        Authorization: `Bearer ${$env.SUPABASE_ANON_KEY}`,
        apikey: $env.SUPABASE_ANON_KEY,
        'Content-Type': 'application/json',
      },
      body: { items: updatedItems },
    });
  },

  // Get list contents
  getList: async (telegramUserId, listName) => {
    return await $http.request({
      method: 'GET',
      url: `${$env.SUPABASE_URL}/rest/v1/user_lists`,
      headers: {
        Authorization: `Bearer ${$env.SUPABASE_ANON_KEY}`,
        apikey: $env.SUPABASE_ANON_KEY,
      },
      qs: {
        telegram_user_id: `eq.${telegramUserId}`,
        list_name: `eq.${listName}`,
      },
    });
  },
};
```

### Enhanced Message Formatting (Research-Based)

```javascript
// Mobile-optimized response formatting
const formatTaskList = (tasks, title) => {
  if (!tasks || tasks.length === 0) {
    return `üìã *${title}*\nNo tasks found.\n\nUse /help for available commands.`;
  }

  const taskItems = tasks
    .slice(0, 8)
    .map((task, index) => {
      const priority = task.priority?.name
        ? task.priority.name === 'High'
          ? 'üî¥'
          : task.priority.name === 'Low'
            ? 'üü¢'
            : 'üü°'
        : '';
      const dueSoon =
        task.dueDate &&
        new Date(task.dueDate) <= new Date(Date.now() + 24 * 60 * 60 * 1000)
          ? '‚è∞'
          : '';

      return `${index + 1}. ${priority} *${task.subject}*${dueSoon}\n   Due: ${formatDate(task.dueDate)}`;
    })
    .join('\n\n');

  const pagination =
    tasks.length > 8 ? `\n\n... and ${tasks.length - 8} more tasks` : '';

  return `üìã *${title}* (${tasks.length})\n\n${taskItems}${pagination}\n\nUse /help for more commands`;
};

const formatSimpleList = (listData) => {
  const items = listData.items || [];
  if (items.length === 0) {
    return `üìù *${listData.list_name}*\nList is empty.\n\n/add_to_list ${listData.list_name} [item] to add items`;
  }

  const listItems = items
    .map((item, index) => {
      const checkbox = item.completed ? '‚úÖ' : '‚óªÔ∏è';
      return `${checkbox} ${item.text}`;
    })
    .join('\n');

  const completedCount = items.filter((item) => item.completed).length;

  return `üìù *${listData.list_name}*\n${completedCount}/${items.length} completed\n\n${listItems}\n\n/add_to_list ${listData.list_name} [item] to add more`;
};
```

### Command Examples

```
User: /my_tasks
Bot: üìã Your Tasks (3)
üî¥ 1. Fix HVAC at Building A ‚è∞
   Due: Today 5:00 PM

üü° 2. Inspect roof damage
   Due: Tomorrow 9:00 AM

üü¢ 3. Order replacement parts
   Due: Friday 3:00 PM

Use /help for more commands

User: /create_list Shopping
Bot: ‚úÖ Created list "Shopping"
Use /add_to_list Shopping [item] to add items

User: /add_to_list Shopping Coffee filters
Bot: ‚úÖ Added "Coffee filters" to Shopping list

User: /show_list Shopping
Bot: üìù Shopping
0/2 completed

‚óªÔ∏è Coffee filters
‚óªÔ∏è Paper towels

/add_to_list Shopping [item] to add more
```

## Testing Requirements

### Task Filtering Tests

- [ ] Test `/my_tasks` returns only user's assigned tasks
- [ ] Test `/overdue` correctly identifies overdue items
- [ ] Test `/today` shows tasks due today only
- [ ] Test `/this_week` includes tasks due within 7 days
- [ ] Verify empty result sets handled gracefully

### List Management Tests

- [ ] Test list creation with valid and invalid names
- [ ] Test adding items to existing lists
- [ ] Test displaying lists with various item counts
- [ ] Test item completion/checking off functionality
- [ ] Test error handling for non-existent lists

### Command Processing Tests

- [ ] Test command parsing with various formats and typos
- [ ] Test case sensitivity handling
- [ ] Test commands with extra spaces or parameters
- [ ] Test command help system completeness
- [ ] Test concurrent command processing

## Risks and Mitigations

### Technical Risks

- **Risk**: Complex command parsing causing workflow failures **Mitigation**:
  Simple regex-based parsing with extensive testing

- **Risk**: Large result sets causing Telegram message limits **Mitigation**:
  Implement pagination and result limiting

### Business Risks

- **Risk**: Feature confusion between work tasks and personal lists
  **Mitigation**: Clear command naming and help documentation

## Definition of Done

- [ ] All task filtering commands working correctly with proper data
- [ ] Simple list creation and management functional
- [ ] Commands easy to discover and use via help system
- [ ] Mobile-optimized response formatting
- [ ] Error handling provides helpful user feedback
- [ ] MVP task management workflow complete end-to-end

## QA Notes

- Test with realistic field service scenarios and data volumes
- Verify command discoverability and user experience
- Check message formatting across different Telegram clients
- Test list functionality with edge cases (very long lists, special characters)

### Performance Requirements

- [ ] Command response time < 3 seconds
- [ ] Task query execution < 2 seconds
- [ ] List operations < 1 second
- [ ] Help system loads instantly

---

_Story follows BMAD framework v4 standards_ _Created for Sprint 2 - Week 2 of
MVP development_
