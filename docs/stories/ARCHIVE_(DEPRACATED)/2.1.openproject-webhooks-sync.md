# Story 2.1: Configure OpenProject Webhooks for Event-Driven Integration

**Priority:** HIGH
**Points:** 5
**Status:** Ready for Development

## User Story
As a **project manager**, I want **OpenProject work package changes to trigger automated workflows** so that **task updates made in OpenProject can notify team members and integrate with external systems**.

## Business Value
- Enables event-driven integration between OpenProject and external systems (n8n workflows, Telegram notifications)
- Provides real-time notifications when work packages are updated in OpenProject
- Allows project managers to use OpenProject as the primary work management interface
- Creates foundation for automated workflow triggers and team notifications

## Acceptance Criteria

### Primary Acceptance Criteria
- [ ] OpenProject webhooks configured for work package status changes, assignments, and due date updates
- [ ] n8n-cloud workflow receives OpenProject webhook events and updates Supabase
- [ ] Conflict resolution implemented with Supabase as source of truth
- [ ] Bidirectional sync loop prevention (avoid infinite webhook cycles)
- [ ] Webhook authentication and security properly configured

### Technical Acceptance Criteria
- [ ] OpenProject webhook endpoints configured for relevant work package events
- [ ] n8n workflow processes OpenProject webhook payload format
- [ ] Supabase updates via `mcp__supabase__*` tools with proper field mapping
- [ ] Conflict detection logic implemented for concurrent updates
- [ ] Webhook delivery monitoring and error handling

### Data Integrity Acceptance Criteria
- [ ] No data loss during sync operations
- [ ] Timestamp-based conflict resolution working correctly
- [ ] Sync status tracking for debugging and monitoring
- [ ] Rollback capability for failed sync operations

## Tasks and Subtasks

### 1. OpenProject Webhook Configuration
- [ ] Access OpenProject admin settings for webhook configuration
- [ ] Create webhook endpoints for work package events:
  - Work package status changed
  - Work package assigned/reassigned  
  - Due date modified
  - Priority changed
- [ ] Configure webhook authentication using API keys or tokens
- [ ] Test webhook delivery to n8n-cloud endpoint

#### OpenProject Webhook Setup (Source: OpenProject Admin Docs)
```yaml
# Navigate to: Administration → API and webhooks → + Webhook
Webhook Configuration:
  Name: "Supabase Task Sync"
  Payload URL: "https://YOUR_N8N.n8n.cloud/webhook/openproject-sync"
  Description: "Sync work package changes to Supabase"
  Signature Secret: "[Generate secure random string]"
  Enabled: true
  Events:
    - work_package:created
    - work_package:updated
  Projects: "All projects" # Or select specific projects
```

#### Webhook Security Verification (HMAC-SHA256)
```javascript
// n8n Code Node to verify OpenProject webhook signature
const crypto = require('crypto');

const signature = $headers['x-openproject-signature'];
const secret = $credentials.openProjectWebhookSecret;
const payload = JSON.stringify($input.json);

// OpenProject uses HMAC-SHA256
const expectedSignature = crypto
  .createHmac('sha256', secret)
  .update(payload)
  .digest('hex');

if (signature !== `sha256=${expectedSignature}`) {
  throw new Error('Invalid webhook signature');
}

return $input.json;
```

### 2. n8n-cloud Sync Workflow Creation  
- [ ] Use `mcp__n8n-cloud__*` tools to create OpenProject sync workflow
- [ ] Add webhook trigger node for OpenProject events
- [ ] Configure webhook authentication and payload validation
- [ ] Add data transformation nodes for field mapping

### 3. Conflict Resolution Logic
- [ ] Implement timestamp comparison logic
- [ ] Configure Supabase as authoritative source for conflicts
- [ ] Add conflict detection and resolution nodes
- [ ] Implement sync status tracking and logging

### 4. Supabase Update Integration
- [ ] Use `mcp__supabase__*` MCP tools for data updates
- [ ] Map OpenProject work package fields to Supabase tasks schema
- [ ] Add data validation and error handling
- [ ] Implement atomic update operations

### 5. Loop Prevention and Monitoring
- [ ] Add sync origin tracking to prevent webhook loops
- [ ] Implement webhook delivery monitoring
- [ ] Create error alerting and dead letter handling
- [ ] Add sync performance and health monitoring

## Dev Notes

### MCP Tools to Use
- **`mcp__n8n-cloud__*`** - For workflow creation and webhook processing
- **`mcp__supabase__*`** - For database updates and conflict resolution
- **DO NOT** create custom sync services - use n8n workflows exclusively

### OpenProject Webhook Configuration
```json
{
  "url": "https://n8n-cloud-instance.com/webhook/openproject-sync",
  "events": [
    "work_package.updated.status",
    "work_package.updated.assigned_to", 
    "work_package.updated.due_date",
    "work_package.updated.priority"
  ],
  "authentication": {
    "type": "bearer_token",
    "token": "webhook-auth-token"
  }
}
```

### n8n Workflow Structure
```
[OpenProject Webhook] 
    ↓
[Payload Validation]
    ↓
[Conflict Detection] → [Skip if Loop]
    ↓
[Data Transformation]
    ↓
[Supabase Update] → [Error Handler]
    ↓
[Sync Status Logging]
```

### Field Mapping Configuration
```javascript
const FIELD_MAPPING = {
  // OpenProject → Supabase
  "status.name": "status",
  "assigned_to.id": "assignee_id", 
  "due_date": "due_date",
  "priority.name": "priority",
  "subject": "title",
  "description": "description",
  "updated_at": "openproject_updated_at"
};
```

### Enhanced Conflict Resolution Logic
```javascript
// Timestamp-based conflict resolution with sync locks
const SYNC_LOCK_DURATION = 10000; // 10 seconds

// Create sync lock before updating
async function acquireSyncLock(taskId) {
  const lock = await supabase
    .from('sync_locks')
    .insert({
      task_id: taskId,
      locked_by: 'openproject-webhook',
      locked_until: new Date(Date.now() + SYNC_LOCK_DURATION),
      created_at: new Date()
    })
    .select()
    .single();
  
  if (lock.error && lock.error.code === '23505') {
    // Lock already exists
    return { acquired: false, reason: 'Task is being synced' };
  }
  return { acquired: true, lockId: lock.data.id };
}

// Main conflict resolution
if (supabaseRecord.updated_at > openProjectPayload.updatedAt) {
  // Supabase is newer, skip update
  return { action: 'skip', reason: 'Supabase has newer data' };
}

// Check for recent Telegram updates (high priority)
if (supabaseRecord.updated_via === 'telegram' && 
    Date.now() - supabaseRecord.updated_at < 30000) {
  // Recent Telegram update takes precedence
  return { action: 'skip', reason: 'Recent Telegram update' };
}

// Proceed with update
return { action: 'update' };
```

#### Database Schema for Sync Management
```sql
-- Sync locks table to prevent race conditions
CREATE TABLE sync_locks (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  task_id VARCHAR(255) UNIQUE NOT NULL,
  locked_by VARCHAR(50) NOT NULL,
  locked_until TIMESTAMPTZ NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Add sync tracking columns to tasks table
ALTER TABLE tasks
ADD COLUMN openproject_id INTEGER UNIQUE,
ADD COLUMN last_synced_from_op TIMESTAMPTZ,
ADD COLUMN last_synced_to_op TIMESTAMPTZ,
ADD COLUMN sync_conflicts JSONB DEFAULT '[]',
ADD COLUMN updated_via VARCHAR(50); -- 'telegram', 'openproject', 'api'

-- Index for efficient conflict detection
CREATE INDEX idx_tasks_sync ON tasks(openproject_id, updated_at);
```

### Critical Implementation Notes
- **Use OpenProject's native webhook system** - no polling or custom triggers
- **Implement proper conflict resolution** - Supabase wins on conflicts
- **Add sync origin tracking** to prevent infinite webhook loops
- **Use atomic operations** for Supabase updates to prevent partial sync states

### Dependencies  
- OpenProject instance deployed and configured (Story 1.1)
- Supabase webhook workflow operational (Story 1.2)
- n8n-cloud instance with OpenProject and Supabase integrations
- Authentication tokens for both OpenProject and Supabase

### OpenProject Webhook Payload Structure (API v3)
```json
{
  "action": "work_package:updated",
  "work_package": {
    "id": 123,
    "subject": "Fix HVAC unit at Building A",
    "description": {
      "raw": "Customer reported no heat",
      "html": "<p>Customer reported no heat</p>"
    },
    "status": {
      "id": 2,
      "name": "In Progress"
    },
    "assignee": {
      "id": 5,
      "name": "Joel Fulford",
      "email": "joel@10netzero.com"
    },
    "dueDate": "2024-01-15",
    "priority": {
      "id": 8,
      "name": "High"
    },
    "updatedAt": "2024-01-10T14:30:00Z",
    "_links": {
      "self": {
        "href": "/api/v3/work_packages/123"
      },
      "project": {
        "href": "/api/v3/projects/1",
        "title": "Field Services"
      }
    }
  },
  "timestamp": "2024-01-10T14:30:00Z"
}
```

#### Complete n8n Workflow Implementation
```javascript
// 1. Webhook Trigger Node
{
  "name": "OpenProject Webhook",
  "type": "n8n-nodes-base.webhook",
  "parameters": {
    "path": "openproject-sync",
    "httpMethod": "POST",
    "responseMode": "onReceived",
    "responseData": "allEntries"
  }
}

// 2. Signature Validation (Code Node)
{
  "name": "Validate Signature",
  "type": "n8n-nodes-base.code",
  "parameters": {
    "jsCode": "// See security verification code above"
  }
}

// 3. Extract Changes (Set Node)
{
  "name": "Extract Changes",
  "type": "n8n-nodes-base.set",
  "parameters": {
    "values": {
      "string": [
        {
          "name": "task_id",
          "value": "={{$json.work_package.id}}"
        },
        {
          "name": "title",
          "value": "={{$json.work_package.subject}}"
        },
        {
          "name": "status",
          "value": "={{$json.work_package.status.name}}"
        },
        {
          "name": "assignee_name",
          "value": "={{$json.work_package.assignee.name}}"
        },
        {
          "name": "due_date",
          "value": "={{$json.work_package.dueDate}}"
        },
        {
          "name": "priority",
          "value": "={{$json.work_package.priority.name.toLowerCase()}}"
        }
      ]
    }
  }
}
```

## Documentation References

### Key Documentation Links
- [OpenProject Webhooks Guide](https://www.openproject.org/docs/system-admin-guide/api-and-webhooks/#webhooks)
- [OpenProject API v3 Work Packages](https://www.openproject.org/docs/api/endpoints/work-packages/)
- [n8n Webhook Node](https://docs.n8n.io/integrations/builtin/core-nodes/n8n-nodes-base.webhook/)
- [n8n Supabase Integration](https://docs.n8n.io/integrations/builtin/app-nodes/n8n-nodes-base.supabase/)

### Best Practices Applied
- **HMAC-SHA256 signature verification** for webhook security
- **Sync locks** to prevent race conditions
- **Timestamp-based conflict resolution** with source tracking
- **Idempotent updates** using OpenProject ID as unique key
- **Comprehensive error logging** for debugging sync issues

## Testing Requirements

### Webhook Delivery Testing
- [ ] Test work package status change in OpenProject triggers webhook
- [ ] Test assignee change triggers webhook with correct data
- [ ] Test due date modification triggers webhook  
- [ ] Test priority changes are captured and synced
- [ ] Verify webhook authentication working correctly

### Bidirectional Sync Testing
- [ ] Create task in Telegram → verify OpenProject creation → modify in OpenProject → verify Supabase sync
- [ ] Test concurrent updates (change same task in both systems simultaneously)
- [ ] Verify conflict resolution (Supabase wins) working correctly
- [ ] Test sync loop prevention (change in Supabase shouldn't trigger loop)

### Error Handling Testing
- [ ] Test webhook delivery when n8n-cloud is down
- [ ] Test sync with invalid/corrupted webhook payloads
- [ ] Test Supabase connection failures during sync
- [ ] Verify rollback on partial sync failures

## Risks and Mitigations

### Technical Risks
- **Risk**: Webhook loops causing infinite sync cycles
  **Mitigation**: Implement sync origin tracking and loop detection

- **Risk**: Data corruption during conflict resolution
  **Mitigation**: Use atomic operations and proper transaction handling

### Business Risks
- **Risk**: Sync delays causing user confusion about task status
  **Mitigation**: Implement real-time monitoring and user feedback

## Definition of Done
- [ ] OpenProject webhooks reliably trigger on work package changes
- [ ] Bidirectional sync operational with conflict resolution
- [ ] No webhook loops or infinite sync cycles  
- [ ] Sync monitoring and error handling in place
- [ ] Data integrity maintained across all sync operations
- [ ] Ready for Story 2.2 reminder system integration

## QA Notes
- Test with realistic project manager workflows
- Verify sync works under concurrent user scenarios
- Check that sync doesn't impact OpenProject or Supabase performance
- Validate conflict resolution edge cases

### Performance Requirements
- [ ] Webhook processing < 2 seconds
- [ ] Supabase updates < 1 second
- [ ] 99.9% sync success rate
- [ ] Conflict resolution < 500ms

---

*Story follows BMAD framework v4 standards*  
*Created for Sprint 2 - Week 2 of MVP development*