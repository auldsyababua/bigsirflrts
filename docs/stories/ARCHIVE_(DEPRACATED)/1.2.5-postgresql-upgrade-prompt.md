# Dev Agent Prompt: PostgreSQL 16+ Migration for FLRTS

## Context
You are taking over Story 1.2.5 (PostgreSQL Version Validation) for the FLRTS project. The current Supabase instance (`thnwlykidzhrsagyjncc`) is running PostgreSQL 15.8, which is incompatible with OpenProject's requirement for PostgreSQL 16+. A new Supabase project needs to be created with PostgreSQL 16+.

## Current State
- **Existing Supabase Project**: `thnwlykidzhrsagyjncc` (PostgreSQL 15.8)
- **Supabase URL**: `https://thnwlykidzhrsagyjncc.supabase.co`
- **Issue**: OpenProject requires PostgreSQL 16+ for compatibility
- **Architecture**: Single-database design where OpenProject connects directly to Supabase

## Your Mission

### 1. Preserve Current Configuration (CRITICAL - DO THIS FIRST)
Before making ANY changes:

1. **Create backup directory**:
   ```bash
   mkdir -p /Users/colinaulds/Desktop/projects/bigsirflrts/infrastructure/supabase-backup-15.8
   ```

2. **Copy all current Supabase configurations** to the backup directory:
   - Copy `/Users/colinaulds/Desktop/projects/bigsirflrts/packages/nlp-service/.env`
   - Copy `/Users/colinaulds/Desktop/projects/bigsirflrts/packages/nlp-service/.env.local`
   - Use Supabase MCP tools to export:
     - Database schema (`mcp__supabase__list_tables` with project_id: `thnwlykidzhrsagyjncc`)
     - Any existing webhooks or triggers
     - Current data if needed (tasks, users, etc.)

3. **Document the current setup** in:
   ```
   /Users/colinaulds/Desktop/projects/bigsirflrts/infrastructure/supabase-backup-15.8/BACKUP-README.md
   ```
   Include:
   - Project reference: `thnwlykidzhrsagyjncc`
   - PostgreSQL version: 15.8
   - All table schemas
   - Any custom functions or triggers
   - Connection strings (with keys redacted)
   - Date of backup
   - Reason for migration

### 2. Create New Supabase Project with PostgreSQL 16+

1. **Use Supabase MCP tools** to create a new project:
   - Ensure it's PostgreSQL 16 or higher
   - Use a clear project name like `flrts-open-project-v16` or similar
   - Document the new project reference

2. **Recreate database structure**:
   - Set up the three schemas as per `/docs/architecture/single-database-architecture.md`:
     ```sql
     CREATE SCHEMA IF NOT EXISTS openproject;
     CREATE SCHEMA IF NOT EXISTS business;
     CREATE SCHEMA IF NOT EXISTS flrts;
     ```

   - Create the OpenProject user with proper permissions:
     ```sql
     CREATE ROLE openproject_user WITH LOGIN PASSWORD 'secure_password';
     GRANT CREATE ON DATABASE postgres TO openproject_user;
     GRANT ALL ON SCHEMA openproject TO openproject_user;
     ```

3. **Migrate FLRTS tables** from the backup:
   - Tasks table
   - Users table
   - Any other tables found in the backup

4. **Set up webhooks** if they exist:
   - Check the backup for any webhook configurations
   - Recreate them in the new project pointing to n8n

### 3. Update Configuration Files

1. **Create new environment file**:
   ```
   /Users/colinaulds/Desktop/projects/bigsirflrts/packages/nlp-service/.env.v16
   ```
   With new Supabase credentials

2. **Update the main .env file** but keep the old one as `.env.backup-15.8`

3. **Test the connection**:
   - Verify PostgreSQL version: `SELECT version();`
   - Test Session Mode connection (port 5432)
   - Ensure it returns PostgreSQL 16.x or higher

### 4. Update Documentation

1. **Update Story 1.2.5** (`/docs/stories/1.2.5.postgresql-version-validation.md`):
   - Mark completed tasks
   - Document the migration decision
   - Add the new project reference

2. **Create migration record**:
   ```
   /Users/colinaulds/Desktop/projects/bigsirflrts/docs/architecture/decisions/001-postgresql-16-migration.md
   ```
   Document:
   - Why: OpenProject compatibility requirement
   - What: Migrated from PostgreSQL 15.8 to 16+
   - When: [Date]
   - Old project: `thnwlykidzhrsagyjncc`
   - New project: [new reference]
   - Backup location: `/infrastructure/supabase-backup-15.8/`

### 5. Validation Checklist

- [ ] Old configuration backed up completely
- [ ] New Supabase project created with PostgreSQL 16+
- [ ] Version verified: `SELECT version()` returns 16.x or higher
- [ ] All three schemas created (openproject, business, flrts)
- [ ] OpenProject user created with proper permissions
- [ ] Connection string uses Session Mode (port 5432)
- [ ] Environment files updated (keeping backups)
- [ ] Documentation updated
- [ ] Connection tested successfully

## Important Notes

1. **DO NOT DELETE** the old Supabase project yet - keep it as reference
2. **Session Mode is MANDATORY** - Use port 5432, NOT 6543
3. **Keep all backups** in the designated backup directory
4. **Test thoroughly** before marking the story complete
5. **Use MCP tools** (`mcp__supabase__*`) for all Supabase operations

## Success Criteria
- New Supabase project running PostgreSQL 16+
- All configurations backed up and documented
- OpenProject can connect successfully
- Story 1.2.5 marked complete with all checkboxes checked

## Files to Reference
- `/docs/architecture/single-database-architecture.md` - Architecture requirements
- `/docs/stories/1.2.5.postgresql-version-validation.md` - Story requirements
- `/packages/nlp-service/.env` - Current configuration to backup
- `/infrastructure/digitalocean/docker-compose.prod.yml` - Production setup reference

## MCP Tools You'll Need
- `mcp__supabase__list_projects` - List existing projects
- `mcp__supabase__get_project` - Get project details
- `mcp__supabase__list_tables` - Export table schemas
- `mcp__supabase__execute_sql` - Run SQL commands
- `mcp__supabase__list_organizations` - May need for project creation

Good luck! Remember: BACKUP FIRST, MIGRATE SECOND.