# Story 3.4: OpenAI Context Injection (MVP Approach)

**Priority:** CRITICAL
**Points:** 8
**Status:** Ready for Development
**Epic:** 3 - NLP Processing

## User Story

As a **field employee**, I want to **send natural language messages that correctly identify people, sites, and entities** so that **tasks are created with accurate assignments without me needing to remember IDs or exact names**.

## Business Value

- Enables natural language task creation without custom parsing
- Reduces errors by providing all valid options to OpenAI
- Simplifies MVP by avoiding complex preprocessing
- Leverages OpenAI's pattern matching capabilities

## Context

For MVP, we're "hardcoding" all valid options directly into the OpenAI prompt rather than building custom preprocessors. This means OpenAI receives complete lists of users, sites, contractors, and other entities, allowing it to match natural language to specific IDs. This approach trades token usage for development simplicity.

## Acceptance Criteria

### Primary Acceptance Criteria

- [ ] OpenAI prompt includes complete list of all FLRTS users with IDs and timezones
- [ ] OpenAI prompt includes complete list of all sites with IDs and aliases
- [ ] OpenAI prompt includes complete list of all contractors/vendors
- [ ] OpenAI prompt includes current UTC timestamp at the top
- [ ] OpenAI correctly matches natural language to provided options
- [ ] System handles timezone conversion based on assignee's timezone

### Technical Acceptance Criteria

- [ ] Prompt dynamically fetches current data from database tables
- [ ] Prompt size stays within OpenAI token limits (consider pagination if needed)
- [ ] Response includes matched IDs, not just names
- [ ] Timezone logic correctly interprets "my time" vs assignee's time

### Performance Acceptance Criteria

- [ ] Prompt construction takes <100ms
- [ ] Database queries for options use proper indexing
- [ ] Options are cached for 5 minutes to reduce DB load

## Implementation Guide

### 1. Database Schema Setup

```sql
-- Ensure openproject.users is synced with personnel table
CREATE TABLE IF NOT EXISTS openproject.users (
  id UUID PRIMARY KEY,
  personnel_id UUID REFERENCES public.personnel(id),
  name TEXT NOT NULL,
  email TEXT,
  timezone TEXT DEFAULT 'UTC',
  created_at TIMESTAMP DEFAULT NOW()
);

-- Create indexes for fast lookup
CREATE INDEX idx_users_personnel ON openproject.users(personnel_id);
CREATE INDEX idx_sites_active ON public.sites(active) WHERE active = true;
```

### 2. Prompt Template Structure

**Research Required**: Use `mcp__ref__ref_search_documentation` to find:

- Current OpenAI GPT-4 token limits
- Best practices for structured prompts
- JSON schema validation in prompts

```javascript
// Pseudo-code for prompt construction
const promptTemplate = `
Current UTC Time: ${new Date().toISOString()}

You are parsing a task creation request. Match entities to the provided options.

AVAILABLE USERS:
${users.map(u => `- ${u.name} (ID: ${u.id}, Timezone: ${u.timezone})`).join('\n')}

AVAILABLE SITES:
${sites.map(s => `- ${s.name} (ID: ${s.id}, Aliases: ${s.aliases.join(', ')})`).join('\n')}

AVAILABLE CONTRACTORS:
${contractors.map(c => `- ${c.name} (ID: ${c.id})`).join('\n')}

TIMEZONE RULES:
- All dates/times are in the assignee's timezone by default
- If assigner (message sender) says "my time", use assigner's timezone: ${assignerTimezone}
- Assigner timezone: ${assignerTimezone}
- Convert all times to UTC in your response

USER MESSAGE: "${message}"

Return a JSON object with these fields:
{
  "assignee_id": "UUID of matched user",
  "site_id": "UUID of matched site (if mentioned)",
  "contractor_id": "UUID of matched contractor (if mentioned)",
  "due_date": "ISO 8601 datetime in UTC",
  "reminder_date": "ISO 8601 datetime in UTC (if mentioned)",
  "task_title": "Brief task title",
  "task_description": "Full task details",
  "timezone_context": "whose timezone was used (assignee|sender)",
  "confidence": 0-100
}
`;
```

### 3. n8n Workflow Configuration

**Research Required**: Use `mcp__n8n-cloud__get_node_info` to get:

- PostgreSQL node configuration for fetching options
- OpenAI node configuration for GPT-4 calls
- Function node for prompt assembly

### 4. Example Test Cases

```yaml
test_cases:
  - input: "Have Bryan send Mark the invoice for site 3 generator by monday at 3pm"
    expected:
      assignee_id: "bryan-uuid"
      contractor_id: "mark-uuid"
      site_id: "site3-uuid"
      due_date: "2024-12-16T21:00:00Z"  # Monday 3pm CST converted to UTC
      timezone_context: "assignee"

  - input: "Remind me to check the east field pump tomorrow at 9am my time"
    expected:
      assignee_id: "sender-uuid"
      site_id: "east-field-uuid"
      due_date: "2024-12-14T17:00:00Z"  # 9am PST converted to UTC
      timezone_context: "sender"
```

## Dependencies

- Story 1.2: Database schema setup
- Story 3.1: OpenAI integration setup
- Personnel table populated with users
- Sites table populated with locations

## Testing Requirements

- Unit tests for prompt construction
- Integration tests with OpenAI API
- Timezone conversion validation
- Entity matching accuracy tests

## Definition of Done

- [ ] All entity types included in prompts
- [ ] OpenAI successfully matches entities with >90% accuracy
- [ ] Timezone conversions work correctly
- [ ] Prompt stays within token limits
- [ ] Performance benchmarks met

## Post-MVP Enhancements

- Implement `/command` preprocessing to reduce ambiguity
- Add `@mention` preprocessing for explicit user selection
- Create entity caching layer
- Implement fuzzy matching fallbacks

## References

- OpenAI GPT-4 API Documentation: [Research via mcp__ref__ref_search_documentation]
- n8n OpenAI Node: [Research via mcp__n8n-cloud__get_node_documentation]
- PostgreSQL JSON Functions: [Research via mcp__ref__ref_search_documentation]
