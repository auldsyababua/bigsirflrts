# Story 2.2: Implement Telegram Reminder System

**Priority:** HIGH **Points:** 5 **Status:** Draft

## User Story

As a **field employee**, I want to **receive Telegram notifications for upcoming
and overdue tasks** so that **I never miss important deadlines and can manage my
workload effectively**.

## Business Value

- Proactive task management through timely notifications
- Reduces missed deadlines and improves project completion rates
- Leverages Telegram as familiar notification channel for field workers
- Integrates with existing task management workflow seamlessly

## Acceptance Criteria

### Primary Acceptance Criteria

- [ ] Scheduled n8n workflow checks for tasks due within 24 hours and overdue
      tasks
- [ ] Telegram notifications sent to assigned employees with task details
- [ ] Reminder frequency configurable (daily check, custom intervals)
- [ ] Clear notification format with task title, due time, and priority
- [ ] Opt-out mechanism for users who don't want reminders

### Technical Acceptance Criteria

- [ ] n8n-cloud scheduled workflow querying OpenProject for due dates
- [ ] Employee mapping between OpenProject assignees and Telegram user IDs
- [ ] Telegram Bot API integration for sending notifications
- [ ] Reminder tracking to prevent duplicate notifications
- [ ] Error handling for failed message delivery

### User Experience Acceptance Criteria

- [ ] Notifications include actionable information (task title, due time,
      priority)
- [ ] Different message formats for upcoming vs overdue tasks
- [ ] Reminders sent during business hours only (configurable)
- [ ] Clear, concise message format optimized for mobile viewing

## Tasks and Subtasks

### 1. n8n Scheduled Workflow Setup

- [ ] Use `mcp__n8n-cloud__*` tools to create reminder workflow
- [ ] Configure schedule trigger (daily at 8 AM, or customizable)
- [ ] Add OpenProject API node to query work packages by due date
- [ ] Configure date range filters (due today, due tomorrow, overdue)

### 2. Employee-Telegram Mapping

- [ ] Create hardcoded mapping between OpenProject user IDs and Telegram IDs
- [ ] Store mapping in workflow variables or external configuration
- [ ] Add fallback handling for unmapped users
- [ ] Test mapping with actual employee Telegram accounts

### 3. Telegram Notification Logic

- [ ] Configure Telegram Bot API node in n8n workflow
- [ ] Design notification message templates for different scenarios
- [ ] Implement message formatting with task details
- [ ] Add error handling for failed message delivery

### 4. Reminder Tracking and Deduplication

- [ ] Implement reminder tracking to prevent duplicates
- [ ] Use workflow memory or external storage for tracking
- [ ] Configure reminder frequency (daily, multiple times per day)
- [ ] Add logic to skip already-notified tasks

### 5. Business Hours and Preferences

- [ ] Configure business hours for notification delivery
- [ ] Add timezone handling for different employee locations
- [ ] Implement opt-out mechanism using Telegram commands
- [ ] Test notification preferences and timing

## Dev Notes

### MCP Tools to Use

- **`mcp__n8n-cloud__*`** - For workflow creation, scheduling, and management
- **Telegram Bot API** (via n8n) - For message delivery
- **OpenProject API** (via n8n) - For querying work packages and due dates
- **DO NOT** create custom reminder services - use n8n's scheduling capabilities

### Employee-Telegram Mapping

```javascript
const EMPLOYEE_TELEGRAM_MAPPING = {
  'emp-001': '@john_smith_bot', // John Smith
  'emp-002': '123456789', // Sarah Johnson (Telegram ID)
  'emp-003': '@mike_davis_field', // Mike Davis
  'emp-004': '987654321', // Lisa Chen (Telegram ID)
};
```

### n8n Workflow Structure

```
[Schedule Trigger: Daily 8AM]
    ‚Üì
[OpenProject API: Query Due Tasks]
    ‚Üì
[Filter: Due Today/Tomorrow/Overdue]
    ‚Üì
[Map: Assignees to Telegram IDs]
    ‚Üì
[Format: Notification Messages] ‚Üí [Send Telegram Messages]
    ‚Üì
[Track: Sent Reminders]
```

### Notification Message Templates

```javascript
// Upcoming task template
const UPCOMING_TEMPLATE = `
üìÖ *Task Reminder*
*{task_title}*
Due: {due_date} at {due_time}
Priority: {priority}
Project: {project_name}

/view_task_{task_id}
`;

// Overdue task template
const OVERDUE_TEMPLATE = `
üö® *OVERDUE TASK*
*{task_title}*
Was due: {due_date} at {due_time}
Overdue by: {overdue_duration}
Priority: {priority}

‚ö†Ô∏è Please update status or reschedule
/view_task_{task_id}
`;
```

### OpenProject Query Configuration

```javascript
// Query work packages due within specified timeframe
const DUE_DATE_QUERY = {
  filters: [
    {
      due_date: {
        operator: 'between',
        values: ['today', 'tomorrow'],
      },
    },
    {
      status: {
        operator: '!',
        values: ['closed', 'completed'],
      },
    },
  ],
};
```

### Critical Implementation Notes

- **Use n8n's native scheduling** - no external cron jobs or custom schedulers
- **Handle timezone differences** for employees in different locations
- **Implement proper error handling** for failed Telegram deliveries
- **Track reminder history** to prevent spam and duplicates

### n8n Schedule Trigger Configuration (Research-Based)

```json
{
  "triggerInterval": "days",
  "dayssBetweenTriggers": 1,
  "triggerAtHour": 8,
  "triggerAtMinute": 0,
  "timezone": "America/Denver"
}
```

**Alternative Cron Configuration for Advanced Scheduling:**

```json
{
  "triggerInterval": "custom",
  "expression": "0 8 * * 1-5" // 8 AM weekdays only
}
```

### OpenProject API Filter Examples (Research-Based)

```javascript
// Due today filter
const TODAY_FILTER = [
  {
    dueDate: {
      operator: '=',
      values: ['t'], // 't' = today in OpenProject API
    },
    status: {
      operator: '!',
      values: ['12', '13'], // Exclude closed/completed status IDs
    },
  },
];

// Overdue filter
const OVERDUE_FILTER = [
  {
    dueDate: {
      operator: '<t',
      values: [], // Less than today
    },
    status: {
      operator: '!',
      values: ['12', '13'],
    },
  },
];

// Due within 24 hours (more precise)
const TOMORROW_FILTER = [
  {
    dueDate: {
      operator: 'between',
      values: ['t+1', 't+1'], // Tomorrow only
    },
  },
];
```

### n8n Workflow Implementation Pattern (Research-Based)

```javascript
// Based on community best practices for command routing
const WORKFLOW_STRUCTURE = {
  'Schedule Trigger': {
    type: 'n8n-nodes-base.scheduleTrigger',
    parameters: {
      rule: {
        interval: [{ field: 'days', dayssBetween: 1, hour: 8, minute: 0 }],
      },
    },
  },
  'OpenProject Query': {
    type: 'n8n-nodes-base.httpRequest',
    parameters: {
      method: 'GET',
      url: '={{$env.OPENPROJECT_URL}}/api/v3/work_packages',
      qs: {
        filters: '={{JSON.stringify($node.filters)}}',
      },
      authentication: 'headerAuth',
    },
  },
  'Employee Mapping': {
    type: 'n8n-nodes-base.code',
    parameters: {
      code: `
const TELEGRAM_MAPPING = {
  "emp-001": "123456789",    // Telegram chat ID
  "emp-002": "@john_doe",    // Username
  "emp-003": "987654321"
};

const workPackages = $input.all();
const notifications = [];

for (const wp of workPackages) {
  const assigneeId = wp.json._links?.assignee?.href?.split('/').pop();
  const telegramId = TELEGRAM_MAPPING[assigneeId];
  
  if (telegramId) {
    notifications.push({
      telegram_id: telegramId,
      task: wp.json,
      message_type: wp.json.dueDate < new Date().toISOString() ? 'overdue' : 'upcoming'
    });
  }
}

return notifications.map(n => ({json: n}));
`,
    },
  },
};
```

### Dependencies

- OpenProject API accessible with work package query permissions
- Telegram Bot configured and accessible to target users
- Employee list with both OpenProject IDs and Telegram contact info
- n8n-cloud instance with scheduling capabilities enabled

### Advanced Telegram Message Formatting (Research-Based)

```javascript
// Based on Telegram Bot API best practices
const formatTaskMessage = (task, messageType) => {
  const emoji = messageType === 'overdue' ? 'üö®' : 'üìÖ';
  const urgency = messageType === 'overdue' ? '*OVERDUE*' : 'Due Soon';

  return {
    text:
      `${emoji} *${urgency}*\n\n` +
      `üìã *${task.subject}*\n` +
      `‚è∞ Due: ${formatDate(task.dueDate)}\n` +
      `üìä Priority: ${task.priority?.name || 'Normal'}\n` +
      `üèó Project: ${task.project?.name}\n\n` +
      `[View Task](${task._links.self.href})`,
    parse_mode: 'Markdown',
    reply_markup: {
      inline_keyboard: [
        [
          { text: '‚úÖ Mark Complete', callback_data: `complete_${task.id}` },
          { text: 'üìÖ Reschedule', callback_data: `reschedule_${task.id}` },
        ],
      ],
    },
  };
};

// Batch message formatting for multiple tasks
const formatBatchMessage = (tasks, userId) => {
  const taskList = tasks
    .map(
      (task, index) =>
        `${index + 1}. ${task.subject} (${formatDate(task.dueDate)})`
    )
    .join('\n');

  return (
    `üìã *Daily Task Summary*\n\n${taskList}\n\n` +
    `Total tasks: ${tasks.length}\n` +
    `Use /my_tasks for detailed view`
  );
};
```

### Error Handling and Retry Logic (Research-Based)

```javascript
// Telegram API error handling based on documentation
const sendTelegramWithRetry = async (chatId, message, retries = 3) => {
  for (let i = 0; i < retries; i++) {
    try {
      const response = await $http.request({
        method: 'POST',
        url: `https://api.telegram.org/bot${$env.TELEGRAM_BOT_TOKEN}/sendMessage`,
        body: {
          chat_id: chatId,
          ...message,
        },
      });

      if (response.ok) return response;

      // Handle rate limiting
      if (response.error_code === 429) {
        const retryAfter = response.parameters?.retry_after || 1;
        await new Promise((resolve) => setTimeout(resolve, retryAfter * 1000));
        continue;
      }

      // Handle blocked users
      if (response.error_code === 403) {
        console.warn(`User ${chatId} has blocked the bot`);
        return null;
      }
    } catch (error) {
      if (i === retries - 1) throw error;
      await new Promise((resolve) => setTimeout(resolve, 1000 * (i + 1)));
    }
  }
};
```

### Business Hours Configuration

```javascript
const BUSINESS_HOURS = {
  start: '08:00',
  end: '17:00',
  timezone: 'America/Denver',
  days: ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'],
};

// Business hours validation function
const isBusinessHours = () => {
  const now = new Date();
  const day = now.getDay(); // 0 = Sunday, 1 = Monday, etc.
  const hour = now.getHours();

  // Check if it's a weekday (1-5)
  if (day < 1 || day > 5) return false;

  // Check if it's within business hours
  return hour >= 8 && hour < 17;
};
```

## Testing Requirements

### Reminder Delivery Testing

- [ ] Test daily scheduled execution triggers correctly
- [ ] Verify OpenProject query returns correct due/overdue tasks
- [ ] Test Telegram message delivery to mapped employees
- [ ] Check message formatting and readability on mobile devices
- [ ] Validate business hours filtering works correctly

### Employee Mapping Testing

- [ ] Test with all mapped employees receive appropriate notifications
- [ ] Test fallback behavior for unmapped users
- [ ] Verify Telegram user ID mapping accuracy
- [ ] Test with employees in different timezones

### Edge Case Testing

- [ ] Test with tasks having no assignee
- [ ] Test with invalid or inactive Telegram user IDs
- [ ] Test during non-business hours (should skip)
- [ ] Test with very long task titles and descriptions
- [ ] Test reminder deduplication (same task multiple days)

## Risks and Mitigations

### Technical Risks

- **Risk**: Telegram API rate limiting with bulk notifications **Mitigation**:
  Implement proper delays between messages, batch processing

- **Risk**: OpenProject API downtime during scheduled check **Mitigation**: Add
  retry logic and error handling for API failures

### Business Risks

- **Risk**: Notification fatigue from too many reminders **Mitigation**:
  Implement smart filtering and user preferences

## Definition of Done

- [ ] Scheduled workflow reliably checks for due tasks daily
- [ ] Telegram notifications delivered to correct employees
- [ ] Message formatting clear and actionable
- [ ] Reminder deduplication prevents spam
- [ ] Business hours and timezone handling working correctly
- [ ] Ready for Story 2.3 lists interface integration

## QA Notes

- Test with actual employee Telegram accounts
- Verify notifications are helpful, not annoying
- Check message delivery reliability across different network conditions
- Test opt-out mechanism works properly

### Performance Requirements

- [ ] OpenProject query execution < 3 seconds
- [ ] Telegram message delivery < 2 seconds per message
- [ ] Workflow execution completes within 5 minutes
- [ ] 95% message delivery success rate

---

_Story follows BMAD framework v4 standards_ _Created for Sprint 2 - Week 2 of
MVP development_
