# Story 3.1: OpenProject API Workflows

## Overview

Configure n8n workflows for all OpenProject REST API v3 operations, providing the integration layer between FLRTS and OpenProject.

## Context

- **Epic**: Epic 3 - OpenProject Integration
- **Priority**: P0 (Critical for MVP)
- **Dependencies**:
  - Story 1.1 (Supabase project setup) - COMPLETED
  - Story 1.3 (n8n cloud setup) - COMPLETED
- **Blocks**: Story 2.1, 2.2, 2.3, 2.4 (All Telegram bot stories depend on this)

## Technical Requirements

### API Contract Overview

**CRITICAL**: FLRTS never writes directly to the database. All operations MUST go through the OpenProject REST API v3.

#### Core Endpoints

- `POST /api/v3/work_packages` - Create new tasks
- `GET /api/v3/work_packages` - List/search tasks with filters
- `GET /api/v3/work_packages/:id` - Get single task details
- `PATCH /api/v3/work_packages/:id` - Update existing tasks (requires lockVersion)
- **Never use DELETE** - Always archive via status change for audit trail

#### Supporting Endpoints

- `GET /api/v3/projects` - List available projects
- `GET /api/v3/types` - List work package types
- `GET /api/v3/statuses` - List available statuses
- `GET /api/v3/users` - List team members
- `GET /api/v3/priorities` - List priority levels
- `POST /api/v3/projects/:id/work_packages/form` - Pre-validate before creation

### OpenProject API Configuration

```typescript
// Environment variables needed in n8n
interface OpenProjectConfig {
  OPENPROJECT_BASE_URL: string;  // "https://ops.10nz.tools"
  OPENPROJECT_API_KEY: string;    // Basic auth API key
  OPENPROJECT_API_VERSION: string; // "v3"
}

// API endpoint structure
const API_BASE = `${OPENPROJECT_BASE_URL}/api/${OPENPROJECT_API_VERSION}`;
```

### Authentication Setup

OpenProject uses Basic Auth with API keys (not username/password):

```typescript
// n8n HTTP Request node configuration
{
  authentication: 'genericCredentialType',
  genericAuthType: 'httpBasicAuth',
  httpBasicAuth: {
    user: 'apikey',  // Always 'apikey' for API key auth
    password: '{{$credentials.openProjectApiKey}}'
  },
  headers: {
    'Content-Type': 'application/json',
    'Accept': 'application/hal+json'
  }
}

// Alternative: Direct header authentication
const authHeader = {
  'Authorization': `Basic ${Buffer.from('apikey:' + apiKeyValue).toString('base64')}`,
  'Content-Type': 'application/json'
};
```

### Core API Operations

#### 1. Work Package CRUD Operations

```javascript
// CREATE Work Package (Full production example)
POST /api/v3/work_packages
Headers: { "Content-Type": "application/json" }
Body: {
  "subject": "Task title",
  "description": {
    "format": "markdown",
    "raw": "Task description",
    "html": "<p>Task description</p>"
  },
  "_links": {
    "project": { "href": "/api/v3/projects/1" },
    "type": { "href": "/api/v3/types/2" },          // Task type
    "status": { "href": "/api/v3/statuses/1" },      // New/Open
    "priority": { "href": "/api/v3/priorities/8" },  // Normal
    "assignee": { "href": "/api/v3/users/3" },
    "responsible": { "href": "/api/v3/users/creator-id" } // Task creator
  },
  "dueDate": "2025-01-15",
  "customField1": "Site A Equipment"  // Custom fields for site/equipment
}

// READ Work Package
GET /api/v3/work_packages/:id

// UPDATE Work Package (PATCH with lockVersion)
PATCH /api/v3/work_packages/:id
Body: {
  "lockVersion": 1,  // CRITICAL: Required for concurrent update protection
  "subject": "Updated title",
  "dueDate": "2025-01-14",
  "_links": {
    "status": { "href": "/api/v3/statuses/7" },  // In Progress
    "assignee": { "href": "/api/v3/users/new-assignee" }
  }
}

// ARCHIVE Work Package (Soft Delete - NEVER use DELETE)
PATCH /api/v3/work_packages/:id
Body: {
  "lockVersion": 2,
  "_links": {
    "status": { "href": "/api/v3/statuses/14" }  // Archived/Closed
  }
}
```

#### 2. Advanced Filtering for READ Operations

```javascript
// GET Work Packages with Complex Filters
GET /api/v3/work_packages?filters=[
  {"assignee":{"operator":"=","values":["taylor"]}},
  {"status":{"operator":"!","values":["closed","archived"]}},
  {"dueDate":{"operator":"<>d","values":["2025-01-10","2025-01-20"]}}
]&pageSize=100&offset=0&sortBy=[["dueDate","asc"]]

// Response format
{
  "_embedded": {
    "elements": [
      {
        "id": 1234,
        "subject": "Server logs review",
        "dueDate": "2025-01-15",
        "lockVersion": 1
      }
    ]
  },
  "total": 45,
  "pageSize": 100,
  "offset": 0
}
```

#### 3. Form-Based Validation (Critical for data integrity)

```javascript
// Get create form with validation
POST /api/v3/projects/:projectId/work_packages/form
Body: {
  "_links": {
    "type": { "href": "/api/v3/types/2" }
  }
}

// Response includes:
{
  "_embedded": {
    "payload": { /* prefilled work package */ },
    "schema": { /* field definitions and constraints */ },
    "validationErrors": { /* current validation issues */ }
  },
  "_links": {
    "commit": {
      "href": "/api/v3/work_packages",
      "method": "POST"
    }
  }
}
```

### n8n Workflow Structure

#### Main API Workflow: `openproject-api-router`

```json
{
  "name": "OpenProject API Router",
  "nodes": [
    {
      "type": "n8n-nodes-base.webhook",
      "name": "API Webhook",
      "parameters": {
        "path": "openproject-api",
        "httpMethod": "POST",
        "responseMode": "lastNode"
      }
    },
    {
      "type": "n8n-nodes-base.switch",
      "name": "Route by Operation",
      "parameters": {
        "dataPropertyName": "operation",
        "values": [
          { "value": "create_work_package" },
          { "value": "update_work_package" },
          { "value": "get_work_package" },
          { "value": "list_work_packages" },
          { "value": "delete_work_package" }
        ]
      }
    },
    {
      "type": "n8n-nodes-base.httpRequest",
      "name": "OpenProject API Call",
      "parameters": {
        "authentication": "genericCredentialType",
        "url": "={{$json.endpoint}}",
        "method": "={{$json.method}}",
        "sendBody": true,
        "bodyParametersJson": "={{$json.body}}",
        "options": {
          "timeout": 30000,
          "retry": {
            "maxTries": 3,
            "waitBetweenTries": 1000
          }
        }
      }
    }
  ]
}
```

#### Sub-workflow: `validate-work-package`

```json
{
  "name": "Validate Work Package",
  "nodes": [
    {
      "type": "n8n-nodes-base.httpRequest",
      "name": "Get Form",
      "parameters": {
        "url": "{{$env.OPENPROJECT_BASE_URL}}/api/v3/projects/{{$json.projectId}}/work_packages/form",
        "method": "POST",
        "sendBody": true,
        "bodyParametersJson": "={{$json.workPackage}}"
      }
    },
    {
      "type": "n8n-nodes-base.if",
      "name": "Check Validation",
      "parameters": {
        "conditions": {
          "boolean": [{
            "value1": "={{$json._embedded.validationErrors}}",
            "operation": "isEmpty"
          }]
        }
      }
    }
  ]
}
```

### Error Handling with Proper Status Codes

```typescript
interface OpenProjectError {
  _type: "Error",
  errorIdentifier: string,
  message: string,
  _embedded?: {
    errors: Array<{
      _type: "Error",
      errorIdentifier: string,
      message: string,
      field?: string  // Which field caused the error
    }>
  }
}

// HTTP Status Code Handling
const ERROR_HANDLERS = {
  400: { // Bad Request
    message: "Invalid request format",
    action: "Check JSON syntax and required fields"
  },
  403: { // Forbidden
    message: "Insufficient permissions",
    action: "Verify API key has necessary permissions"
  },
  422: { // Unprocessable Entity
    message: "Validation errors",
    action: "Extract field-specific errors and show to user"
  },
  409: { // Conflict
    message: "Update conflict (lockVersion mismatch)",
    action: "Fetch latest version and retry with new lockVersion"
  }
};

// Common error identifiers
const ERROR_CODES = {
  "urn:openproject-org:api:v3:errors:InvalidUser": "Invalid user reference",
  "urn:openproject-org:api:v3:errors:PropertyConstraintViolation": "Field validation failed",
  "urn:openproject-org:api:v3:errors:MissingPermission": "Insufficient permissions",
  "urn:openproject-org:api:v3:errors:UpdateConflict": "lockVersion mismatch",
  "urn:openproject-org:api:v3:errors:InvalidRequestBody": "Request body is invalid"
};
```

## Implementation Checklist

### Phase 1: Core Setup

- [ ] Create n8n credentials for OpenProject API
- [ ] Set up environment variables in n8n
- [ ] Create main API router workflow
- [ ] Test authentication with simple GET request

### Phase 2: CRUD Operations

- [ ] Implement CREATE work package workflow
- [ ] Implement READ work package workflow
- [ ] Implement UPDATE with lockVersion handling
- [ ] Implement DELETE workflow
- [ ] Add form-based validation

### Phase 3: Advanced Features

- [ ] Implement batch operations
- [ ] Add filtering and pagination
- [ ] Create custom field handling
- [ ] Set up webhook listeners for OpenProject events

### Phase 4: Error Handling

- [ ] Add retry logic for transient failures
- [ ] Implement error notification workflow
- [ ] Create fallback mechanisms
- [ ] Add request/response logging

## Testing Requirements

### Unit Tests (n8n workflow testing)

```javascript
// Test data generator
const testWorkPackage = {
  subject: `Test Task ${Date.now()}`,
  description: { format: "markdown", raw: "Test description" },
  _links: {
    project: { href: "/api/v3/projects/1" },
    type: { href: "/api/v3/types/2" }
  }
};

// Test scenarios
1. Create work package with minimal fields
2. Create with all fields populated
3. Update with concurrent lockVersion
4. Handle validation errors gracefully
5. Test pagination with 100+ items
```

### Integration Tests

- Verify Supabase → n8n → OpenProject flow
- Test Telegram command → OpenProject task creation
- Validate webhook delivery from OpenProject
- Test rate limiting behavior (100 requests/min)

## Performance Considerations

- OpenProject API rate limit: 100 requests per minute
- Average response time: 200-500ms
- Implement caching for frequently accessed data (projects, types, statuses) - 5 minute TTL
- Use batch endpoints where available
- Pagination limit: 100 items per page
- Connection pooling: Reuse HTTP connections
- Implement exponential backoff for rate limit errors (429 status)

## Security Requirements

- Store API keys in n8n credentials manager
- Never log sensitive data (API keys, user data)
- Validate all input before sending to OpenProject
- Implement request signing for webhook validation
- Use HTTPS for all API communications
- Rotate API keys every 90 days
- Implement IP allowlisting for production

## Developer Resources

### Essential Documentation

```bash
# Core API reference
mcp__ref__ref_search_documentation "OpenProject REST API v3 work packages"

# Authentication guide
mcp__ref__ref_search_documentation "OpenProject API authentication bearer token"

# Custom fields
mcp__ref__ref_search_documentation "OpenProject custom fields API"
```

### n8n Node Configuration

```javascript
// Recommended n8n nodes for this story
const N8N_NODES = [
  'n8n-nodes-base.webhook',      // API endpoint
  'n8n-nodes-base.httpRequest',  // OpenProject API calls
  'n8n-nodes-base.switch',       // Route operations
  'n8n-nodes-base.function',     // Data transformation
  'n8n-nodes-base.cache',        // Response caching
  'n8n-nodes-base.errorTrigger'  // Error handling
];
```

## Acceptance Criteria

1. ✅ All CRUD operations work via n8n workflows
2. ✅ Form validation prevents invalid data submission
3. ✅ lockVersion prevents concurrent update conflicts
4. ✅ Error responses are properly formatted and logged
5. ✅ Response time < 1 second for single operations
6. ✅ Batch operations handle 50+ items successfully

## Notes for Developers

- Always use the form endpoint before creating/updating to validate data
- The `lockVersion` field is REQUIRED for all updates - fetch current version first
- OpenProject uses HAL+JSON format - all references use `_links` with `href`
- Custom fields are prefixed with `customField` followed by the field ID
- Rate limiting is enforced at the API level - implement exponential backoff
- Use the OpenProject sandbox at `https://community.openproject.org` for testing
