{
  "module": "Supabase Integration Layer",
  "status": "complete",
  "timestamp": "${ISO_TIMESTAMP}",
  "project": {
    "id": "thnwlykidzhrsagyjncc",
    "name": "FLRTS",
    "region": "us-east-2",
    "db": { "version": "15.8" }
  },
  "authConfig": {
    "site_url": "http://localhost:3000",
    "external_google_enabled": true,
    "notes": [
      "Development site_url detected; set to production host for email links.",
      "Google provider enabled; verify redirect URIs and key rotation policies."
    ]
  },
  "storage": { "buckets": [] },
  "codeUsage": {
    "clients": [
      {
        "location": "packages/nlp-service/src/index.ts",
        "key": "anon",
        "tables": ["parsing_logs"],
        "risk": "Writes from anon context depend on permissive RLS; consider service role or secured RPC"
      },
      {
        "location": "supabase/functions/telegram-webhook/index.ts",
        "key": "service_role",
        "tables": ["telegram_webhook_logs"],
        "risk": "Service role in edge function is acceptable; ensure RLS bypass is intentional"
      },
      {
        "location": "supabase/functions/parse-request/index.ts",
        "key": "service_role",
        "tables": ["parse_logs", "parse_queue"],
        "risk": "Ensure tables and minimal privileges exist"
      }
    ]
  },
  "schemaFindings": {
    "rlsEnabled": ["lists", "reminders", "list_shares", "notification_preferences"],
    "rlsMissingOrUnspecified": ["tasks", "audit_logs", "notification_queue", "telegram_sessions", "parse_logs", "parse_queue", "telegram_webhook_logs"],
    "migrationsReviewed": [
      "database/migrations/001_initial_schema.sql",
      "database/migrations/003_flrts_features.sql",
      "database/migrations/004_monitoring_views.sql"
    ],
    "notes": [
      "RLS explicitly enabled for lists/reminders/shares/preferences.",
      "No explicit RLS statements found for tasks or logging/queue tables.",
      "Code references parse_logs/parse_queue/telegram_webhook_logs but migrations for these tables were not found."
    ]
  },
  "monitoring": {
    "views": ["monitoring.database_metrics", "monitoring.slow_queries", "monitoring.active_connections", "monitoring.table_stats", "monitoring.performance_summary"],
    "grants": "SELECT granted to role 'authenticated'",
    "risk": "Authenticated users may read DB performance metadata; review exposure"
  },
  "issues": [
    {
      "id": "SB-1",
      "severity": "HIGH",
      "title": "RLS not defined for sensitive tables (tasks, audit/logging/queue tables)",
      "location": "database/migrations/*",
      "description": "Only a subset of tables have RLS enabled (lists/reminders/shares/prefs). Tasks and several operational tables lack explicit RLS in migrations.",
      "remediation": "Enable RLS and define least-privilege policies for all user-facing or PII-bearing tables; restrict anon to read-only where appropriate."
    },
    {
      "id": "SB-2",
      "severity": "MEDIUM",
      "title": "Missing migrations for tables referenced by code (parse_logs, parse_queue, telegram_webhook_logs)",
      "location": "supabase/functions/*; packages/nlp-service/*",
      "description": "Edge functions and services write to these tables but corresponding CREATE TABLE migrations were not found.",
      "remediation": "Add migrations for the missing tables with appropriate indexes and RLS; ensure CI applies them."
    },
    {
      "id": "SB-3",
      "severity": "MEDIUM",
      "title": "Auth site_url set to localhost",
      "location": "Supabase Auth config",
      "description": "Auth configuration uses http://localhost:3000; email links and redirects will be incorrect in production.",
      "remediation": "Set site_url to production URL and adjust uri_allow_list accordingly."
    },
    {
      "id": "SB-4",
      "severity": "LOW",
      "title": "Monitoring views exposed to authenticated role",
      "location": "database/migrations/004_monitoring_views.sql",
      "description": "SELECT is granted on monitoring views to authenticated; may leak performance metrics to application users.",
      "remediation": "Restrict access to admin/maintainer role or proxy via secured RPC."
    }
  ],
  "recommendations": [
    "Add RLS and policies for all user/PII-bearing tables (tasks, logs, queues).",
    "Create migrations for parse_logs, parse_queue, telegram_webhook_logs and align with code.",
    "Set Supabase Auth site_url to production domain; verify email templates.",
    "Review grants on monitoring views; lock down to admin roles.",
    "Prefer service role or secured RPCs for writes; avoid anon writes where possible."
  ]
}
