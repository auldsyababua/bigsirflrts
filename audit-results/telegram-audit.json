{
  "module": "Telegram Bot Service",
  "status": "complete",
  "timestamp": "2025-09-28T00:00:00Z",
  "components": [
    {
      "name": "Edge Function (telegram-webhook)",
      "paths": [
        "supabase/functions/telegram-webhook/index.ts",
        "infrastructure/supabase/functions/telegram-webhook/index.ts"
      ],
      "security": {
        "webhookSecretValidation": "X-Telegram-Bot-Api-Secret-Token compared to TELEGRAM_WEBHOOK_SECRET",
        "botTokenHandling": "Used only in server-side fetch to Telegram API",
        "n8nQueueing": "Optional N8N_WEBHOOK_URL for asynchronous processing"
      }
    },
    {
      "name": "Webhook Setup",
      "paths": [
        "supabase/deploy-telegram-webhook.sh",
        "docs/setup/telegram-bot.md"
      ],
      "notes": [
        "setWebhook uses secret_token and drops pending updates",
        "docs outline best practices and debugging commands"
      ]
    },
    {
      "name": "Ingress Rate Limiting",
      "paths": [
        "infrastructure/docker/nginx/nginx-single.conf"
      ],
      "notes": [
        "limit_req configured for /webhook/ paths to n8n; Supabase edge path protected by secret token"
      ]
    }
  ],
  "issues": [
    {
      "id": "TG-1",
      "severity": "MEDIUM",
      "title": "n8n webhook queueing without request authentication",
      "location": "telegram-webhook queueForProcessing()",
      "description": "Queue POST to N8N_WEBHOOK_URL lacks signing or shared secret; if URL leaks, could be abused.",
      "remediation": "Add HMAC signature header with shared secret, or use n8n basic auth/API key with TLS."
    },
    {
      "id": "TG-2",
      "severity": "LOW",
      "title": "No application-level rate limiting on edge function",
      "location": "supabase edge handler",
      "description": "Relies on Telegram rate limiting and secret token; consider per-IP or token-bucket limiting as defense-in-depth.",
      "remediation": "Implement lightweight token bucket by chatId/userId or utilize Supabase edge function rate limiting features if available."
    },
    {
      "id": "TG-3",
      "severity": "LOW",
      "title": "Logging of user metadata without explicit retention policy",
      "location": "logToSupabase()",
      "description": "Usernames and chat IDs are logged for processing; ensure retention and access controls are documented.",
      "remediation": "Define retention period and RLS access policy for logs table; mask usernames if not required."
    }
  ],
  "recommendations": [
    "Sign n8n webhook requests (HMAC) and validate in n8n",
    "Add lightweight rate limiting at edge function level",
    "Document and enforce retention/RLS for Telegram logs",
    "Add monitoring/alarming for error paths that return 200"
  ]
}

