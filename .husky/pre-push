#!/usr/bin/env bash
# Allow skipping the hook entirely (emergencies/refactors)
if [ "$SKIP_PREPUSH" = "1" ]; then
  echo "â­ï¸  SKIP_PREPUSH=1 set â€” skipping pre-push checks."
  exit 0
fi

echo "ğŸš€ Running pre-push (fast) â€” P0 unit tests by default"

# Run unit tests (fast, deterministic)
echo "ğŸ“¦ Running unit tests (@P0)..."
if ! npm run test:unit; then
  echo "\nâŒ Unit tests failed!"
  echo "Please fix before pushing. Run 'npm run test:unit' to debug."
  exit 1
fi

echo "âœ… Unit tests passed!"

# Optional: include integration tests when requested
if [ "$RUN_INTEGRATION" = "true" ]; then
  echo "ğŸ”— RUN_INTEGRATION=true â€” running integration tests..."
  if ! npm run test:integration; then
    echo "\nâŒ Integration tests failed!"
    echo "Please fix before pushing. Run 'npm run test:integration' to debug."
    exit 1
  fi
  echo "âœ… Integration tests passed!"
else
  echo "ğŸ” Skipping integration tests (set RUN_INTEGRATION=true to include)"
fi

echo "ğŸ‰ Pre-push checks complete"

exit 0